(function(){var r,p,t,u,v,w,n,x,y,z,A;y=function(c){var b,e;if(null==c||"string"!==typeof c||""===c)return"";b=c.split("\n");null==b&&(b=c);e=b.filter(function(a){return function(a){return""!==a}}(this)).map(function(a){return function(a){return a.match(/^\s+/)}}(this)).map(function(a){return null===a?"":a[0]}).reduce(function(a,d){return d.length<a.length?d:a});return""===e?c:b.map(function(a){return a.replace(new RegExp("^"+e),"")}).join("\n")};window.markdown=function(c){if(null==c)return"";typeof c===
Function&&(c=c());c=c.toString();return marked(y(c),{smartypants:!0})};Function.prototype.fcall=Function.prototype.call;Boolean.prototype.fcall=function(){return this};String.prototype.fcall=function(){return this};n=function(c,b){return console.assert(c,b)};x=function(c,b){return"<a href='./_inv_"+b+"' class='once'>"+c.fcall()+"</a>"};Array.prototype.remove=function(c){var b;if(-1<(c=this.indexOf(c)))return[].splice.apply(this,[c,c-c+1].concat(b=[])),b};A=function(c,b){return"<a href='./_act_"+b+
"' class='once'>"+c+"</a>"};z=function(c,b){window.unitname=b;return c=c.replace(/\{\{(.+)\}\}/g,function(c,a){b=window.unitname;window.unitname=void 0;return A(a,b)})};w=function(){return function(c){var b,e;this.init=function(){$("#page").on("click","a",function(a){var d;a.preventDefault();a=$(this);d=a.attr("href");(a.hasClass("once")||d.match(/[?&]once[=&]?/))&&salet.view.clearLinks(d);if(d.match(salet.linkRe))return salet.processClick(d)});$("#load").on("click","a",function(a){return window.location.reload()});
if(this.hasLocalStorage())return $(document).on("click","#erase",function(a){a.preventDefault();return salet.eraseSave()}),$(document).on("click","#save",function(a){a.preventDefault();return salet.saveGame()})};this.disableSaving=function(){return $("#save").addClass("disabled")};this.enableSaving=function(){return $("#save").removeClass("disabled")};this.enableErasing=function(){return $("#erase").removeClass("disabled")};this.disableErasing=function(){return $("#erase").addClass("disabled")};this.enableLoading=
function(){return $("#load").removeClass("disabled")};this.disableLoading=function(){return $("#load").addClass("disabled")};this.scrollTopTo=function(a){return $("html,body").stop().animate({scrollTop:a},500)};this.scrollBottomTo=function(a){return this.scrollTopTo(a-$(window).height())};this.scrollToBottom=function(){return this.scrollTopTo($("html").height()-$(window).height())};this.clearContent=function(a){var d;null==a&&(a="#content");"#content"===a&&(d=document.getElementById("intro"),null!=
d&&(d.innerHTML=""));return document.querySelector(a).innerHTML=""};this.prepareContent=function(a){"function"===typeof a&&(a=a());a instanceof $&&(a=a[0].outerHTML);return a.toString()};this.write=function(a){return function(d,f){null==f&&(f="#current-room");return a.append(d,f)}}(this);this.append=function(a,d){var f,b;null==d&&(d="#content");if(null!=a&&""!==a){a=this.prepareContent(a);if(f=$(d))return b=markdown(a),f.promise().done(function(){return f.append(b)}),b;f=$("#content");f.html(a);return f.html()}};
this.replace=function(a,d){var f;if(""!==a)return a=this.prepareContent(a),f=$(d),f.promise().done(function(){return f.html(a)})};this.clearLinks=function(a,d){var f,b,m,c;a?(null==d&&(d="#page"),c=$(d).find("a[href='"+a+"']")):(null==d&&(d="#content"),c=$(d).find("a"));b=0;for(m=c.length;b<m;b++){f=c[b];f=$(f);if(!a&&(f.hasClass("sticky")||f.attr("href").match(/[?&]sticky[=&]?/)))return;f.replaceWith($("<span>").addClass("ex_link").html(f.html()))}return!0};this.writeChoices=function(a){var d,f,
b,c,g,e,k,l,q;if(null!=a&&0!==a.length){c=salet.getCurrentRoom();b=$("<ul>").addClass("options");d=g=0;for(e=a.length;g<e;d=++g)q=a[d],l=salet.rooms[q],n(l,"unknown_situation".l({id:q})),l!==c&&((k=l.optionText.fcall(l,c.name))||(k="choice".l({number:d+1})),f=$("<li>"),d=$("<span>"),l.canChoose.fcall(this,c)&&(d=$("<a>").attr({href:q})),d.html(k),f.html(d),b.append(f));return this.write(b)}};this.mark_all_links_old=function(){return $("#page .new").removeClass("new")};this.removeTransient=function(a){return function(d){var f;
null==d&&(d=void 0);f="#content";d&&(f=".room-"+d);d=$(f+" .transient");d=d.add(f+" .options");d=d.add($(f+" a").filter(function(){return $(this).attr("href").match(/[?&]transient[=&]?/)}));a.hideBlock(d,!0);return a.clearLinks(void 0,f)}}(this);this.endOutputTransaction=function(){var a,d,f,b,c;if(salet.interactive&&(a=$(".new"),0!==a.length))return c=$(window).height(),b=0,f=a.first().offset().top,a=a.last().offset().top+a.last().height(),d=a-f,$(".options").not(".new").length&&(b=$(".options").not("new").height()),
d>c-b-50?this.scrollTopTo(f-.25*c-b):f>$("body").height()-c?this.scrollToBottom():this.scrollBottomTo(a+100-b)};this.hasLocalStorage=function(){return null!=window.localStorage};this.fixClicks=function(){return $("body").on("click","ul.options li",function(a){a=$("a",this);if(0<a.length)return $(a.get(0)).click()})};this.showBlock=function(a){return salet.interactive?$(a).slideDown("slow",function(){return $(a).fadeTo(500,1)}):$(a).show()};this.hideBlock=function(a,d){var f;null==d&&(d=!1);a=$(a);
if(!salet.interactive)return d?a.remove():a.hide();f=function(){return $(this).remove()};!1===d&&(f=void 0);a.finish().fadeTo(500,0,function(){return a.slideUp(250,f)})};this.updateWays=function(a,d){var f,b,c,g,e,k;if(null!==document.getElementById("ways")&&(f="",a)){g=[];b=0;for(c=a.length;b<c;b++)k=a[b],null!=salet.rooms[k]?(e=salet.rooms[k].title.fcall(this,d),f+="<li class='nav-item'><a class='nav-link' href='"+k+"'>"+e+"</a></li>",this.replace(f,"#ways"),g.push(this.showBlock(".ways #ways_hint"))):
g.push(this.hideBlock(".ways #ways_hint",!1));return g}};this.cycleLink=function(a){return"<a href='./_replacer_cyclewriter' class='cycle' id='cyclewriter'>"+a+"</a>"};for(b in c)e=c[b],this[b]=e;return this}}();v=function(){return function(c){var b,e;if(null==c.name)return console.error("Trying to create a unit with no name"),null;this.order=0;this.visible=!0;this.look=function(a){return function(d){if(a.dsc&&""!==a.dsc&&a.visible)return d=a.dsc.fcall(a,d).toString(),z(d,a.name)}}(this);this.takeable=
!1;this.display="";this.take=function(a){return function(){return"You take the "+a.display.fcall(a)+"."}}(this);this.act=function(a){return function(){return"You don't find anything extraordinary about the "+a.display.fcall(a)+"."}}(this);this.dsc=function(a){return function(){return"You see a {{"+a.display.fcall(a)+"}} here."}}(this);this.inv=function(a){return function(){return"It's a "+a.display.fcall(a)+"."}}(this);this.location="";this.put=function(a){return function(d){return null!=salet.rooms[d]?
salet.rooms[d].take(a):console.error("Could not find location "+d+" for a unit "+a.name)}}(this);this["delete"]=function(a){return function(d){null==d&&(d=!1);!1===d&&(d=a.location);return salet.rooms[d].drop(a)}}(this);for(b in c)e=c[b],this[b]=e}}();window.unit=function(c,b){null==b&&(b={});b.name=c;return new v(b)};r=function(){return function(c){var b,e;this.inventory=[];this.take=function(a){return function(d){return a.inventory.push(d)}}(this);this.drop=function(a){return function(d){var f,
b,c,g;g=a.inventory;b=0;for(c=g.length;b<c;b++)if(f=g[b],f.name===d)return a.inventory.remove(f),!0;return!1}}(this);this.has=function(a){return function(d){var f,b,c,g;g=a.inventory;b=0;for(c=g.length;b<c;b++)if(f=g[b],f.name===d)return!0;return!1}}(this);this.listinv=function(a){return function(d){var f,b,c,g;g=a.inventory;b=0;for(c=g.length;b<c;b++)if(f=g[b],f.name===d)return x(f.display.fcall(f),f.name)}}(this);this.inv=function(a){return function(d){var b,c,e,g;g=a.inventory;c=0;for(e=g.length;c<
e;c++)if(b=g[c],b.name===d)return b.inv.fcall(b)}}(this);for(b in c)e=c[b],this[b]=e;return this}}();u=function(){return function(c){var b,e;this.visited=0;this.title=this.name="Room";this.units=[];this.canChoose=this.canView=!0;this.displayOrder=this.priority=1;this.canExit=this.canSave=!0;this.tags=[];this.ways=[];this.choices="";this.optionText="Choice";this.extendSection=this.dsc=!1;this.clear=!0;this.exit=function(a){return function(a){return!0}}(this);this.enter=function(a){return function(a){return!0}}(this);
this.entering=function(a){return function(d,b){var c,e;null==b&&(b=!1);if(d!==a.name&&null!=salet.rooms[d]&&null!=salet.rooms[d].canExit&&(!1===salet.rooms[d].canExit||!1===salet.rooms[d].canExit.fcall(salet.rooms[d],a.name))&&!1===b)return salet.doTransitionTo(d,!0);a.clear&&null!=d&&salet.view.clearContent();null==salet.rooms[d]||a.clear||(!1===salet.rooms[d].extendSection?salet.view.removeTransient(d):salet.view.removeTransient());d!==a.name&&null!=salet.rooms[d]&&(a.visited++,null!=salet.rooms[d].exit&&
salet.rooms[d].exit(a.name));a.enter&&a.enter(d);a.extendSection||(c=a.classes?" "+a.classes.join(" "):"",e=document.getElementById("current-room"),null!=e&&e.removeAttribute("id"),salet.view.append("<section id='current-room' data-room='"+a.name+"' class='room-"+a.name+c+"'></section>"));d!==a.name&&null!=a.before&&salet.view.write(markdown(a.before.fcall(a,d)));salet.view.write(a.look(d));d!==a.name&&null!=a.after&&salet.view.write(markdown(a.after.fcall(a,d)));null!=a.beforeChoices&&a.beforeChoices.fcall(a,
d);a.choices&&salet.view.writeChoices(salet.getSituationIdChoices(a.choices,a.maxChoices));null!=a.afterChoices&&a.afterChoices.fcall(a,d);if(salet.autosave&&a.canSave)return salet.saveGame()}}(this);this.unitDelimiter="";this.look=function(a){return function(d){var b,c,e,g,h,k;salet.view.updateWays(a.ways,a.name);h="";a.dsc&&""!==a.dsc&&(b=a.dsc.fcall(a,d).toString(),h+=markdown(b));b=[];g=a.units;c=0;for(e=g.length;c<e;c++)k=g[c],k.name&&"function"===typeof k.look&&k.look(d)&&b.push({order:k.order,
content:k.look(d)});b.sort(function(a,d){return a.order-d.order});c=0;for(e=b.length;c<e;c++)d=b[c],h+=a.unitDelimiter+d.content;return markdown(h)}}(this);this.take=function(a){return function(d){d.location=a.name;return a.units.push(d)}}(this);this.drop=function(a){return function(d){var b,c,e,g;e=a.units;b=0;for(c=e.length;b<c;b++)if(g=e[b],g.name===d)return a.units.splice(a.units.indexOf(g),1),g.location=null,a.units}}(this);this.act=function(a){return function(d){var b,c,e,g,h;if(e=d.match(/^_(act|cycle|inv)_(.+)$/)){if("inv"===
e[1])return salet.view.write(salet.character.inv(e[2]));g=a.units;b=0;for(c=g.length;b<c;b++)if(h=g[b],h.name===e[2]&&"act"===e[1]){if(h.takeable)return salet.character.take(h),a.drop(e[2]),salet.view.write(h.take.fcall(h).toString());if(null!=h.act)return salet.view.write(h.act.fcall(h))}console.error("Could not find "+e[2]+" in current room.")}b=d.match(/^_(\w+)_(.+)$/);e={writer:function(b){b=a.writers[b].fcall(a,d);b=markdown(b);return salet.view.write(b)},replacer:function(b){var c;c=a.writers[b].fcall(a,
d);return salet.view.replace(c,"#"+b)},inserter:function(b){var c;c=a.writers[b].fcall(a,d);c=markdown(c);return salet.view.write(c,"#"+b)}};if(b){g=[b[1],b[2]];c=g[0];g=g[1];if(!a.writers.hasOwnProperty(b[2]))throw Error("Tried to call undefined writer: "+d);return e[c](g)}if(a.actions.hasOwnProperty(d))return a.actions[d].call(a,d);throw Error("Tried to call undefined action: "+d);}}(this);this.register=function(a){return function(){return null==a.name?(console.error("Room has no name"),a):salet.rooms[a.name]=
a}}(this);this.writers={};this.link=function(a){return function(d){if(salet.rooms[d])return a.ways.push(d)}}(this);this.bilink=function(a){return function(d){var b;if(b=salet.rooms[d])return a.link(d),b.link(a.name)}}(this);for(b in c)e=c[b],this[b]=e;return this}}();window.room=function(c,b){null==b&&(b={});b.name=c;return(new u(b)).register()};p=function(){function c(b){null==b&&(b="en");this.lang=document.getElementsByTagName("html")[0].getAttribute("lang")||b}c.prototype.strings={en:{choice:"Choice {number}",
link_not_valid:"The link '{link}' doesn't appear to be valid.",link_no_action:"A link with a situation of '.', must have an action.",unknown_room:"Room not found: {id}.",erase_message:"This will permanently delete this character and immediately return you to the start of the game. Are you sure?",dice_string_error:"Couldn't interpret your dice string: '{string}'."}};c.prototype.push=function(b,c){return null!=this.strings[b]?this.strings[b]=$.extend(this.strings[b],c):this.strings[b]=c};c.prototype.localize=
function(b,c){var a;null==c&&(c=this.lang);return null!=this.strings[c]&&(a=this.strings[c][b])?a:b};return c}();window.i18n=new p;String.prototype.l=function(c){var b,e;b=window.i18n.localize(this);if("function"===typeof b)b=b(c);else if(c)for(e in c)b=b.replace(new RegExp("\\{"+e+"\\}"),c[e]);return b};t=function(){function c(b){var c;this.seed=b;this.multiplier=1664525;this.modulo=4294967296;this.offset=1013904223;null!=this.seed&&0<=(c=this.seed)&&c<this.modulo||(this.seed=(new Date).valueOf()*
(new Date).getMilliseconds()%this.modulo)}c.prototype.seed=function(b){return this.seed=b};c.prototype.getSeed=function(){return this.seed};c.prototype.randn=function(){return this.seed=(this.multiplier*this.seed+this.offset)%this.modulo};c.prototype.randf=function(){return this.randn()/this.modulo};c.prototype.rand=function(b){return Math.floor(this.randf()*b)};c.prototype.randRange=function(b,c){return b+this.rand(c-b)};c.prototype.randomInt=function(b){return this.rand(b)};c.prototype.randomElement=
function(b){return b[this.rand(b.length)]};c.prototype.odds=function(b,c,a){b=c-b;if(0>=b)return 100;b=Math.floor(100*(1-b/a));return 0>=b?0:b};c.prototype.dice=function(b,c,a){var d,f;null==b&&(b=1);null==a&&(a=0);for(d=f=0;0<=b?d<=b:d>=b;0<=b?++d:--d)f=1+Math.floor(this.randf()*c);a&&(f+=a);return f};c.prototype.diceString=function(b){var c,a;c=b.match(/^([1-9][0-9]*)?d([%FA]|[1-9][0-9]*)([-+][1-9][0-9]*)?$/);if(!c)throw Error("dice_string_error".l({string:b}));a=1;b=0;c[1]&&(a=parseInt(c[1],10));
c[3]&&(b=parseInt(c[3],10));switch(c[2]){case "F":c=3;b-=2*a;break;case "%":c=100;break;default:c=parseInt(c[2],10)}return this.dice(a,c,b)};return c}();p=function(){return function(c){var b,e;this.character=new r;this.game_id=null;this.game_version="1.0";this.autoload=this.autosave=!0;this.rnd=null;this.time=0;this.rooms={};this.start="start";this.linkRe=/^([0-9A-Za-z_-]+|\.)(\/([0-9A-Za-z_-]+))?$/;this.init=function(){};this.enter=function(a,d){};this.afterEnter=function(a,d){};this.beforeAction=
function(a,d){};this.afterAction=function(a,d){};this.exit=function(a,d){};this.getSituationIdChoices=function(a,d){var b,c,e,g,h,k,l;e=0;"string"===typeof a&&(a=[a]);b=[];e=0;for(c=a.length;e<c;e++)if(g=a[e],"#"===g.substr(0,1))for(h=this.getRoomsTagged(g.substr(1)),k=0,l=h.length;k<l;k++)g=h[k],b.push(g);else b.push(g);c=this.getCurrentRoom();e=[];h=0;for(g=b.length;h<g;h++)l=b[h],k=this.rooms[l],n(k,"unknown_room".l({id:l})),k.canView.fcall(this,c,k)&&e.push({priority:k.priority,id:l,displayOrder:k.displayOrder});
e.sort(function(a,b){return b.priority-a.priority});b=[];null!=d&&e.length>d&&(e=e.slice(-d));h=0;for(g=e.length;h<g;h++)c=e[h],b.push({id:c.id,displayOrder:c.displayOrder});b.sort(function(a,b){return a.displayOrder-b.displayOrder});h=[];g=0;for(c=b.length;g<c;g++)e=b[g],h.push(e.id);return h};this.progress={seed:null,sequence:[],path:[],saveTime:null};this.current=null;this.interactive=!0;this.linkStack=this.startTime=null;this.getCurrentRoom=function(){return this.current?this.rooms[this.current]:
null};this.getSaveId=function(){return"salet_"+this.game_id+"_"+this.game_version};this.processLink=function(a){if(null!==this.linkStack)this.linkStack.push(a);else{this.view.mark_all_links_old();this.linkStack=[];for(this.processOneLink(a);0<this.linkStack.length;)a=this.linkStack.shift(),this.processOneLink(a);this.linkStack=null;this.view.endOutputTransaction();return this.view.enableSaving()}};this.goTo=function(a){return this.processClick(a)};this.processOneLink=function(a){var b,c,e;if(b=a.match(this.linkRe))return a=
this.checkTimer(),c=b[1],b=b[3],"."!==c&&c!==this.current?this.doTransitionTo(c):b&&(e=this.getCurrentRoom())&&(c=!1,this.beforeAction&&(c=this.beforeAction(e,b)),!0!==c&&e.act(b),this.afterAction&&this.afterAction(e,b)),this.view.append(a);console.error("link_not_valid".l());console.error(a)};this.processClick=function(a){var b;this.time=.001*(new Date).getTime()-this.startTime;if(b=a.match(this.linkRe)[1])if(b="."===b?this.getCurrentRoom():this.getRoom(b),n(b,"unknown_room".l({id:b})),!b.canSave)return this.processLink(a);
this.progress.sequence.push({link:a,when:this.time});null!=this.getRoom(a)&&this.progress.path.push(a);return this.processLink(a)};this.goBack=function(a){null==a&&(a=2);a=this.progress.path.length<=a?this.start:this.progress.path[this.progress.path.length-a];if(null!=a)return this.processClick(a)};this.doTransitionTo=function(a,b){var c,e,m;null==b&&(b=!1);m=this.current;e=this.getCurrentRoom();c=this.rooms[a];n(c,"unknown_room".l({id:a}));e&&this.exit&&this.exit(m,a,b);this.current=a;this.enter&&
this.enter(m,a,b);c.entering(m,b);if(this.afterEnter)return this.afterEnter(m,a,b)};this.eraseSave=function(a){var b;null==a&&(a=!1);b=this.getSaveId();if(localStorage.getItem(b)&&(a||confirm("erase_message".l())))return localStorage.removeItem(b),window.location.reload()};this.getRoomsTagged=function(a){var b,c,e,m,g,h,k;k=[];g=this.rooms;for(c in g)for(b=g[c],h=b.tags,e=0,m=h.length;e<m;e++)if(b=h[e],b===a){k.push(c);break}return k};this.saveGame=function(){var a;a=.001*(new Date).getTime();this.progress.saveTime=
a-this.startTime;localStorage.setItem(this.getSaveId(),JSON.stringify({progress:this.progress}));this.view.disableSaving();this.view.enableErasing();return this.view.enableLoading()};this.loadGame=function(a){var b,c,e;if(this.interactive){this.progress=a.progress;this.character=new r;this.rnd=new t(this.progress.seed);this.init();this.interactive=!1;c=this.progress.sequence;a=0;for(b=c.length;a<b;a++)e=c[a],this.time=e.when,this.processLink(e.link);this.interactive=!0;a=.001*(new Date).getTime();
return a-this.progress.saveTime}};this.view=new w;this.getSave=function(){var a;this.getSaveId();a=!1;this.view.hasLocalStorage()&&(a=localStorage.getItem(this.getSaveId()),a=JSON.parse(a));return a};this.beginGame=function(){var a;this.view.fixClicks();if((a=this.getSave())&&this.autoload)try{return this.loadGame(a),this.view.disableSaving(),this.view.enableErasing()}catch(b){return console.log("There was an error loading your save. The save will be overwritten."),console.error(b)}else return this.rnd=
new t,this.progress.seed=this.rnd.getSeed(),this.progress.sequence=[{link:this.start,when:0}],this.startTime=.001*(new Date).getTime(),this.init(),this.doTransitionTo(this.start)};this.getRoom=function(a){if(null!=this.rooms[a])return this.rooms[a]};this.here=function(){return this.getCurrentRoom()};this.isVisited=function(a){return(a=this.getRoom(a))?!!a.visited:0};this.timers={};this.addTimer=function(a,b,c,e){null==c&&(c=!1);null==e&&(e=1);this.timers[a]={step:e,repeatable:c,action:b,set:this.progress.sequence.length};
return this.timers};this.dropTimer=function(a){return delete this.timers[a]};this.resetTimer=function(a){return this.timers[a].set=this.progress.sequence.length};this.checkTimer=function(){var a,b,c,e;if(0===Object.keys(this.timers).length)return"";b="";a=this.timers;for(e in a)c=a[e],this.progress.sequence.length-c.set===c.step&&(b+="\n\n"+c.action.fcall(this),c.repeatable||this.dropTimer(e));return b};for(b in c)e=c[b],this[b]=e;return this}}();window.salet=new p;salet.view.init()}).call(this);

//# sourceMappingURL=index.min.js.map